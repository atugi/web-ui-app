# データ取込みミニアプリ 開発チェックリスト (Layer方式)

目的:
- **最短で「ボタン1つで動作」+「過去機能を壊さない最低限テスト」状態を作る**
- 必須ライン(= 次のミニアプリ制作に進んで良い境界)まで終えたら、新しいミニアプリへ移行
- 余力があるときに段階的に安定化 / 運用強化を追加

---
### 変更点メモ（旧マスターチェックリストとの差分）
- 旧ルール「既存の変数/関数/列名は絶対変更禁止」は **“外部公開インターフェイスを変える時はテスト追加＆互換(旧名→新名ラッパ)で可”** に緩和。（旧記述参照）
- 旧ルール「SCHEMA_VERSION を毎回 +1」は **現状頻繁変更が無いため保留**（必要になれば導入）。
- 旧ルール「`update_master()` 後に本体で重複行 assert」は **テスト（2回取込みテスト）で保証し、本体は WARNING ログ** に変更。



## ◎ 記号の意味

| 記号 / ラベル | 意味 |
|---------------|------|
| ✅ (必須) | **必ず実行**。ここを全て終えたら新ミニアプリに進んでよい。 |
| ◇ (推奨) | 早めにやると安心度UP（時間があれば Layer1 のうちに） |
| ☆ (任意) | 後回しでもOK。余力・気分で実装検討。 |
| Layer1 必須ライン | ここまで終えたら次のミニアプリ制作に着手可能。 |

---

## Layer 1 : 「最短で動く & 最低限壊れない」ゾーン

> **目標:** Streamlit ボタンで実行 + テスト(2本) + CI 緑 + ログで状況把握

| # | 状態 | 優先 | タスク | 目的 / 完了条件 / 補足 |
|---|-------|------|--------|------------------------|
| 1 | [ ] ✅ | ★★★ | 依存の“正”を一つに統一（`requirements.txt` か `pyproject.toml`） | どこを編集するか迷わない。不要な requirements* を削除 or アーカイブ。 |
| 2 | [ ] ✅ | ★★★ | `src/ingest/` へコード移動 / `main.py` に `main()` 定義 | 構造固定。`python -m ingest.main` が動く。 |
| 3 | [ ] ✅ | ★★★ | logging 導入 (print → logger) | 実行開始/件数/警告/終了が INFO / WARNING / ERROR で出る。 |
| 4 | [ ] ✅ | ★★★ | 簡易スキーマ検証 | 期待列との差分を検査し、欠損/余分列があれば停止 or 警告。 |
| 5 | [ ] ✅ | ★★★ | 重複チェック（仮PK = `date + machine_id` 等） | 取込み時に重複件数をログ表示。重複は追加しないか警告。 |
| 6 | [ ] ✅ | ★★☆ | 最小テスト1 (初回取り込み) | 小CSV→取込み→結果の列集合 & 行数を assert。`pytest` 緑。 |
| 7 | [ ] ✅ | ★★☆ | CI (GitHub Actions) で pytest 実行 | Push/PR で自動テスト。緑でマージOKルールを決める。 |
| 8 | [ ] ✅ | ★★☆ | Streamlit 最小UI | ボタン押す→`main()` 実行→完了/追加行数/重複数表示。 |
| 9 | [ ] ◇ | ★★☆ | バックアップファイルを日時入りに変更 | 例: `slot_master_YYYYMMDD_HHMM.bak.parquet`。世代を複数残せる。 |
|10 | [ ] ✅ | ★★☆ | 2ステップゴールデンテスト | 同CSVを2回取込み→2回目で行数増えずテスト緑。重複防止保証。 |
|11 | [ ] ☆ | ★★☆ | README に “機能追加/テスト更新手順” を 5行追記 | 将来の手順忘れ防止。例: 変更→テスト追加→expected 更新→CI 確認。 |
|12 | [ ] ☆ | ★☆☆ | `.env.example` 整理 / `.env` git無視 | 認証やパス機密化の土台。後で値を増やすとき安心。 |

### ✅ Layer1 必須ライン
**#1～#10 が全て [x] になったら次のミニアプリ制作着手OK。#11,#12 は任意。**

---

## Layer 2 : 安定化 & ガード強化（余裕があれば）

| # | 状態 | ラベル | タスク | 効果 / 条件 |
|---|-------|--------|--------|-------------|
|13 | [ ] ◇ | 推奨 | バックアップ世代保持 (最新5個以外削除) | 古い .bak が溜まらない |
|14 | [ ] ◇ | 推奨 | アトミック書き込み (tmp→rename) | 途中失敗で破損ファイル残さない |
|15 | [ ] ◇ | 推奨 | ネガティブテスト（列欠損 CSV で失敗確認） | スキーマガードの実効性 |
|16 | [ ] ◇ | 推奨 | PK 定数化 (`PRIMARY_KEYS = [...]`) | 変更時1か所修正 |
|17 | [ ] ◇ | 推奨 | ログをファイル出力 + ローテーション | 長期運用時の追跡性 |
|18 | [ ] ◇ | 推奨 | Streamlit ログ末尾 & 指標表示 | UI だけで状態把握 |
|19 | [ ] ◇ | 推奨 | ゴールデン “日跨ぎ” テスト | 2日分追加挙動を固定 |
|20 | [ ] ☆ | 任意 | pre-commit 運用（README に `pre-commit install`） | コード品質自動化 |
|21 | [ ] ☆ | 任意 | CHANGELOG 運用開始 | 変更理由記録 |

---

## Layer 3 : 運用性 / 拡張準備（必要になったら）

| # | 状態 | ラベル | タスク | 効果 / いつやるか |
|---|-------|--------|--------|-------------------|
|22 | [ ] ☆ | 任意 | 失敗通知 (Slack/Webhook) | 常時監視不要化 / 自動通知 |
|23 | [ ] ☆ | 任意 | 性能テスト (大量CSV時間計測) | スケール兆候検知 |
|24 | [ ] ☆ | 任意 | スキーマバージョン管理 | 列変更の履歴化 |
|25 | [ ] ☆ | 任意 | CLI エントリポイント (`python -m ingest`) | バッチ/cron 連携容易 |
|26 | [ ] ☆ | 任意 | Docker イメージ軽量化 (マルチステージ) | 配布・再ビルド高速化 |
|27 | [ ] ☆ | 任意 | coverage 計測 | テスト抜け把握 |
|28 | [ ] ☆ | 任意 | 簡易アーキ図 (Mermaid or PNG) | 新規参入/自分の再認識 |
|29 | [ ] ☆ | 任意 | `features/` 雛形追加 | 解析/特徴量追加の起点 |
|30 | [ ] ☆ | 任意 | FastAPI プレースホルダ | API化ニーズ発生後 |

---

## 運用ミニガイド

### 変更手順 (README 追記用 例)
1. ブランチ作成 (`feature/xxx`)
2. コード変更 & ローカル `pytest`
3. 仕様変更多い場合: ゴールデン更新 + 理由をコミットメッセージ
4. `streamlit` で手動確認
5. Push → PR → CI 緑でマージ

### 共通関数の共通化タイミング
- 2つ目のミニアプリで**重複が見えた瞬間**に `src/common/` を切る（今は早すぎる共通化をしない）

---

## メモ欄

| 日付 | 進捗 / 気付き | 次アクション |
|------|---------------|--------------|
|      |               |              |
|      |               |              |
|      |               |              |

---

## 完了サマリ欄

| 区分 | 日付 | コメント |
|------|------|----------|
| Layer1 必須完了 |      |          |
| Layer2 導入開始 |      |          |
| 初回別ミニアプリ開始 |      |          |

---

### 次の使い方
- このファイルを Git で管理し、進捗をコミットすると履歴が残る
- 新ミニアプリごとに複製して “差分で必要な部分” を薄くした派生チェックリストを作れる

